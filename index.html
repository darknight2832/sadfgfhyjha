<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Face Capture & Email Form</title>
    <!-- Font Awesome Icons (optional) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .camera-section {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        video, canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .capture-btn {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 12px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(76,175,80,0.3);
        }
        .capture-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        .capture-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .form-section {
            margin-top: 30px;
            display: none;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px 20px;
            align-items: center;
        }
        .form-grid label {
            font-weight: 600;
            color: #555;
            text-align: right;
        }
        .form-grid input, .form-grid select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }
        .auto-detect-box {
            background: #f0f8ff;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .auto-detect-box h3 {
            margin-top: 0;
            color: #0b3d5f;
        }
        .send-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 25px;
            transition: 0.3s;
        }
        .send-btn:hover {
            background: #0b7ad1;
        }
        .status {
            text-align: center;
            margin-top: 15px;
            color: #666;
        }
        .email-setup {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
    <!-- Face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-camera-retro"></i> Smart Face Capture & Email</h1>
        
        <!-- EmailJS Setup Instructions (visible only once) -->
        <div id="setupInstructions" class="email-setup">
            <strong>ðŸ“§ Email Setup (required once):</strong>
            <ol style="margin:5px 0 0 15px; padding-left:0;">
                <li>Go to <a href="https://www.emailjs.com" target="_blank">EmailJS.com</a> and sign up for a <strong>free account</strong>.</li>
                <li>In the Dashboard: <strong>Email Services â†’ Add New Service â†’ SMTP</strong>.<br> 
                    Enter the SMTP settings you provided: <br>
                    <code>Host: smtp.gmail.com, Port: 587, User: tusharsainivpn1@gmail.com, Password: saol mgbf eywg cwuo</code><br>
                    (Gmail requires an <strong>App Password</strong> â€“ if you use 2FA, generate one; otherwise enable "less secure apps").</li>
                <li>After creating the service, copy the <strong>Service ID</strong>.</li>
                <li>Go to <strong>Email Templates â†’ Create New Template</strong>. Design an email (you can use our default variables below). Copy the <strong>Template ID</strong>.</li>
                <li>Go to <strong>Account â†’ API Keys</strong> and copy your <strong>Public Key</strong> (User ID).</li>
                <li>Paste the three IDs into the script at the marked locations (search for <code>YOUR_</code>).</li>
            </ol>
            <p style="margin-bottom:0;">Once set up, this box can be removed.</p>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlayCanvas"></canvas>
        </div>
        <button id="captureBtn" class="capture-btn" disabled>
            <i class="fas fa-circle"></i> Capture Face
        </button>
        <div id="captureStatus" class="status">Loading face detection models...</div>

        <!-- Form Section (hidden until capture) -->
        <div id="formSection" class="form-section">
            <div class="auto-detect-box" id="autoDetectInfo">
                <h3><i class="fas fa-magic"></i> Autoâ€‘detected from Face</h3>
                <p><strong>Frame size:</strong> <span id="frameSizeVal"></span></p>
                <p><strong>Frame type suggestion:</strong> <span id="frameTypeVal"></span></p>
                <p><strong>Face width:</strong> <span id="faceWidthVal"></span> mm</p>
                <p><strong>IPD:</strong> <span id="ipdVal"></span> mm</p>
                <p><strong>Face shape:</strong> <span id="faceShapeVal"></span></p>
            </div>

            <h3>Customer Details</h3>
            <div class="form-grid">
                <label>Name:</label><input type="text" id="name" placeholder="Full name">
                <label>Age:</label><input type="number" id="age">
                <label>DOB:</label><input type="date" id="dob">
                <label>Gender:</label>
                <select id="gender">
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
                <label>Address:</label><input type="text" id="address">
                <label>Ward no:</label><input type="text" id="ward">
                <label>Booth no/PS no:</label><input type="text" id="booth">
                <label>Mobile WhatsApp number:</label><input type="tel" id="mobile">
                <label>Power:</label><input type="text" id="power">
                <label>Right (O.D):</label><input type="text" id="od">
                <label>Left (O.S):</label><input type="text" id="os">
                <label>Spherical:</label><input type="text" id="spherical">
                <label>Cylindrical:</label><input type="text" id="cylindrical">
                <label>Axis:</label><input type="text" id="axis">
                <label>Prism:</label><input type="text" id="prism">
                <label>Base:</label><input type="text" id="base">
            </div>

            <button id="sendBtn" class="send-btn">
                <i class="fas fa-envelope"></i> Send via Email
            </button>
            <div id="emailStatus" class="status"></div>
        </div>
    </div>

    <script>
        // ---------- GLOBAL VARIABLES ----------
        let video = document.getElementById('video');
        let overlayCanvas = document.getElementById('overlayCanvas');
        let ctx = overlayCanvas.getContext('2d');
        let captureBtn = document.getElementById('captureBtn');
        let formSection = document.getElementById('formSection');
        let statusDiv = document.getElementById('captureStatus');

        // Auto-detect fields
        let frameSizeSpan = document.getElementById('frameSizeVal');
        let frameTypeSpan = document.getElementById('frameTypeVal');
        let faceWidthSpan = document.getElementById('faceWidthVal');
        let ipdSpan = document.getElementById('ipdVal');
        let faceShapeSpan = document.getElementById('faceShapeVal');

        // Captured data
        let capturedImageData = null; // base64 image
        let detectedMeasurements = null;

        // ---------- FACE-API SETUP ----------
        async function loadModels() {
            statusDiv.innerText = 'Loading face detection models...';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights');
                statusDiv.innerText = 'Models loaded. Starting camera...';
                startCamera();
            } catch (err) {
                statusDiv.innerText = 'Failed to load models. Check internet connection.';
                console.error(err);
            }
        }

        // ---------- CAMERA ----------
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: 640, height: 480 } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    overlayCanvas.width = video.clientWidth;
                    overlayCanvas.height = video.clientHeight;
                    detectFaceLoop();
                    captureBtn.disabled = false;
                    statusDiv.innerText = 'Place your face inside the green ring and press "Capture Face"';
                };
            } catch (err) {
                statusDiv.innerText = 'Camera access denied.';
                console.error(err);
            }
        }

        // ---------- FACE DETECTION LOOP + RING OVERLAY ----------
        async function detectFaceLoop() {
            if (!video.paused && !video.ended) {
                // Resize canvas to match video display size
                if (overlayCanvas.width !== video.clientWidth || overlayCanvas.height !== video.clientHeight) {
                    overlayCanvas.width = video.clientWidth;
                    overlayCanvas.height = video.clientHeight;
                }

                // Draw the green ring
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                ctx.beginPath();
                let centerX = overlayCanvas.width / 2;
                let centerY = overlayCanvas.height / 2;
                let radius = Math.min(overlayCanvas.width, overlayCanvas.height) * 0.3;
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 4;
                ctx.stroke();

                // Add text
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#00ff00';
                ctx.fillText('Align face here', centerX - 80, centerY - radius - 10);

                // Detect face
                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                               .withFaceLandmarks();
                if (detections) {
                    // Scale detection coordinates to canvas size
                    const canvasRect = overlayCanvas.getBoundingClientRect();
                    const videoRect = video.getBoundingClientRect();
                    const scaleX = overlayCanvas.width / videoRect.width;
                    const scaleY = overlayCanvas.height / videoRect.height;
                    const box = detections.detection.box;
                    ctx.beginPath();
                    ctx.rect(box.x * scaleX, box.y * scaleY, box.width * scaleX, box.height * scaleY);
                    ctx.strokeStyle = '#ffaa00';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Store landmarks for later use (scaled to video dimensions)
                    const landmarks = detections.landmarks.positions;
                    window.lastLandmarks = landmarks.map(p => ({ x: p.x, y: p.y }));
                    window.lastDetectionBox = { x: box.x, y: box.y, width: box.width, height: box.height };
                }
                requestAnimationFrame(detectFaceLoop);
            }
        }

        // ---------- CAPTURE BUTTON ----------
        captureBtn.addEventListener('click', function() {
            if (!window.lastLandmarks) {
                alert('No face detected! Please position your face inside the ring.');
                return;
            }

            // Capture image from video
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            capturedImageData = tempCanvas.toDataURL('image/jpeg', 0.9); // base64

            // Perform measurements
            const measurements = analyzeFace(window.lastLandmarks, video.videoWidth, video.videoHeight);
            detectedMeasurements = measurements;

            // Update UI
            frameSizeSpan.innerText = measurements.frameSize;
            frameTypeSpan.innerText = measurements.frameType;
            faceWidthSpan.innerText = measurements.faceWidthMm;
            ipdSpan.innerText = measurements.ipdMm;
            faceShapeSpan.innerText = measurements.faceShape;

            formSection.style.display = 'block';
            statusDiv.innerText = 'Face captured! Fill the form and send email.';
        });

        // ---------- FACE ANALYSIS (Frame size & type) ----------
        function analyzeFace(landmarks, imgW, imgH) {
            // Landmark indices for 68-point model (face-api.js)
            // Left temple ~0, right temple ~16, forehead ~19, chin ~8,
            // left eye pupil ~39, right eye pupil ~42, etc.
            // We'll use approximate indices.

            function getLm(idx) {
                return landmarks[idx] || { x: 0, y: 0 };
            }

            // Face width: left temple (0) to right temple (16)
            const leftTemple = getLm(0);
            const rightTemple = getLm(16);
            let faceWidthPx = Math.hypot(rightTemple.x - leftTemple.x, rightTemple.y - leftTemple.y);

            // Face height: forehead (19) to chin (8)
            const forehead = getLm(19);
            const chin = getLm(8);
            let faceHeightPx = Math.hypot(chin.x - forehead.x, chin.y - forehead.y);

            // Interpupillary distance: left eye (39) to right eye (42)
            const leftPupil = getLm(39);
            const rightPupil = getLm(42);
            let ipdPx = Math.hypot(rightPupil.x - leftPupil.x, rightPupil.y - leftPupil.y);

            // Jaw width: using points around jaw (4 and 12)
            const leftJaw = getLm(4);
            const rightJaw = getLm(12);
            let jawWidthPx = Math.hypot(rightJaw.x - leftJaw.x, rightJaw.y - leftJaw.y);

            // Forehead width: left brow (17) to right brow (26)
            const leftBrow = getLm(17);
            const rightBrow = getLm(26);
            let foreheadWidthPx = Math.hypot(rightBrow.x - leftBrow.x, rightBrow.y - leftBrow.y);

            // Convert pixels to mm using average IPD = 63 mm
            const AVG_IPD_MM = 63;
            let mmPerPx = ipdPx > 0 ? AVG_IPD_MM / ipdPx : 0.5; // fallback

            let faceWidthMm = faceWidthPx * mmPerPx;
            let faceHeightMm = faceHeightPx * mmPerPx;
            let ipdMm = ipdPx * mmPerPx;
            let jawWidthMm = jawWidthPx * mmPerPx;
            let foreheadWidthMm = foreheadWidthPx * mmPerPx;

            // ---- Frame size suggestion ----
            let frameSize;
            if (faceWidthMm < 120) frameSize = "44-46 mm (Small)";
            else if (faceWidthMm < 130) frameSize = "48-50 mm (Medium)";
            else if (faceWidthMm < 140) frameSize = "52-54 mm (Large)";
            else frameSize = "56+ mm (Extra Large)";

            // ---- Face shape classification ----
            let shape = "Oval";
            if (faceWidthMm > 0) {
                let hwRatio = faceHeightMm / faceWidthMm;
                let jawForeheadRatio = jawWidthMm / foreheadWidthMm;

                if (hwRatio > 1.3) shape = "Oblong";
                else if (hwRatio >= 1.1 && hwRatio <= 1.3) shape = "Oval";
                else {
                    if (jawForeheadRatio > 0.95) shape = "Square";
                    else shape = "Round";
                }
                if (foreheadWidthMm > jawWidthMm * 1.2) shape = "Heart";
            }

            // ---- Frame type suggestion ----
            const suggestions = {
                "Oval": "Most styles work well â€“ try Wayfarer or Aviator",
                "Round": "Angular/rectangular frames to add definition",
                "Square": "Round or oval frames to soften angles",
                "Heart": "Bottom-heavy frames, Cat-eye, or Rimless",
                "Oblong": "Deep frames, wayfarers, or wraparounds"
            };
            let frameType = suggestions[shape] || "Wayfarer (versatile)";

            return {
                faceWidthMm: Math.round(faceWidthMm * 10) / 10,
                faceHeightMm: Math.round(faceHeightMm * 10) / 10,
                ipdMm: Math.round(ipdMm * 10) / 10,
                jawWidthMm: Math.round(jawWidthMm * 10) / 10,
                foreheadWidthMm: Math.round(foreheadWidthMm * 10) / 10,
                faceShape: shape,
                frameSize: frameSize,
                frameType: frameType
            };
        }

        // ---------- EMAIL SENDING with EmailJS ----------
        // ========== PASTE YOUR EMAILJS CREDENTIALS HERE ==========
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';      // From EmailJS Account â†’ API Keys
        const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';      // The SMTP service you created
        const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';    // The email template ID
        const YOUR_EMAIL = 'Jagatdal106VS@gmail.com';      // Where to send the email
        // ========================================================

        // Initialize EmailJS
        (function initEmailJS() {
            if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        })();

        document.getElementById('sendBtn').addEventListener('click', function() {
            if (!capturedImageData) {
                alert('No captured image! Please capture your face first.');
                return;
            }
            if (EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                alert('âš ï¸ Please set your EmailJS credentials in the script (search for "YOUR_PUBLIC_KEY").\nSee the setup instructions at the top.');
                return;
            }

            // Collect form data
            let formData = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value,
                ward: document.getElementById('ward').value,
                booth: document.getElementById('booth').value,
                mobile: document.getElementById('mobile').value,
                power: document.getElementById('power').value,
                right_od: document.getElementById('od').value,
                left_os: document.getElementById('os').value,
                spherical: document.getElementById('spherical').value,
                cylindrical: document.getElementById('cylindrical').value,
                axis: document.getElementById('axis').value,
                prism: document.getElementById('prism').value,
                base: document.getElementById('base').value,
                // Auto-detected
                frame_size: detectedMeasurements.frameSize,
                frame_type: detectedMeasurements.frameType,
                face_width: detectedMeasurements.faceWidthMm + ' mm',
                ipd: detectedMeasurements.ipdMm + ' mm',
                face_shape: detectedMeasurements.faceShape,
                // Image as base64 (strip header for EmailJS)
                image: capturedImageData.split(',')[1],  // remove "data:image/jpeg;base64,"
                to_email: YOUR_EMAIL
            };

            let statusEl = document.getElementById('emailStatus');
            statusEl.innerHTML = 'â³ Sending email...';

            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, formData)
                .then(function(response) {
                    statusEl.innerHTML = 'âœ… Email sent successfully!';
                    statusEl.style.color = 'green';
                }, function(error) {
                    statusEl.innerHTML = 'âŒ Failed to send email. Check console.';
                    statusEl.style.color = 'red';
                    console.error('EmailJS error:', error);
                });
        });

        // ---------- START ----------
        loadModels();

        // Adjust canvas when video resizes
        window.addEventListener('resize', () => {
            overlayCanvas.width = video.clientWidth;
            overlayCanvas.height = video.clientHeight;
        });
    </script>
</body>
</html>
