<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>LensAI ¬∑ Smart Order Form</title>
  
  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0c111c;
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      color: #eef2f6;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .app {
      max-width: 1100px;
      width: 100%;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #9bb8ff, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .badge {
      background: rgba(56, 136, 255, 0.15);
      border: 1px solid #3888ff80;
      border-radius: 100px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      color: #b8d4ff;
    }

    /* Grid: left (camera) + right (auto fields) */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 30px;
    }

    @media (max-width: 700px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Camera card */
    .camera-card {
      background: #0f1524;
      border-radius: 24px;
      padding: 20px;
      border: 1px solid #1f2a41;
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
    }

    .camera-title {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 15px;
      font-weight: 600;
      color: #cbd5e6;
    }

    .camera-box {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      border: 2px solid rgba(255,255,255,0.1);
    }

    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    video {
      transform: scaleX(-1);
    }

    .auto-values {
      background: #0f1524;
      border-radius: 24px;
      padding: 20px;
      border: 1px solid #1f2a41;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .auto-row {
      background: #1a2333;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
    }

    .auto-row:last-child { margin-bottom: 0; }

    .auto-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #8ba0c0;
      margin-bottom: 8px;
    }

    .auto-value {
      font-size: 30px;
      font-weight: 800;
      background: linear-gradient(135deg, #fcd34d, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
    }

    .auto-hint {
      font-size: 13px;
      color: #a0b8d4;
      margin-top: 6px;
    }

    /* Form */
    .form-section {
      background: #0f1524;
      border-radius: 24px;
      padding: 24px;
      border: 1px solid #1f2a41;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #9bb8ff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #1f2a41;
      padding-bottom: 12px;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 18px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #8ba0c0;
    }

    .field input, .field select {
      background: #1a2333;
      border: 1px solid #2c3a52;
      border-radius: 12px;
      padding: 12px 14px;
      color: white;
      font-size: 14px;
      font-family: inherit;
      transition: 0.2s;
    }

    .field input:focus, .field select:focus {
      border-color: #3888ff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(56,136,255,0.2);
    }

    .field input[readonly] {
      background: #1e2a3a;
      color: #c0d0e5;
      border-color: #3a4a62;
    }

    .row-2 {
      grid-column: span 2;
    }

    .btn-submit {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #3888ff, #1e5ad9);
      border: none;
      border-radius: 40px;
      color: white;
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid rgba(255,255,255,0.2);
      margin-top: 12px;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(56,136,255,0.4);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1f2a41;
      border-left: 6px solid #3888ff;
      border-radius: 16px;
      padding: 16px 24px;
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 9999;
      animation: slideIn 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="app">
    
    <!-- Header -->
    <div class="header">
      <div class="logo">üëì LensAI ¬∑ Smart Fit</div>
      <div class="badge">‚ö° 22‚Äëpt facial analysis</div>
    </div>

    <!-- Camera + Auto‚Äëdetect row -->
    <div class="grid">
      <!-- Left: camera -->
      <div class="camera-card">
        <div class="camera-title">
          <span>üì∏ Face scanner</span>
          <span style="color:#6b7fa6; font-size:12px; margin-left:auto;" id="cameraStatus">initializing...</span>
        </div>
        <div class="camera-box">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div style="margin-top:16px; display:flex; gap:12px; justify-content:center;">
          <div style="background:#1a2333; border-radius:40px; padding:8px 16px; font-size:13px;">
            <span id="distanceBadge">üìè distance: --</span>
          </div>
        </div>
      </div>

      <!-- Right: auto‚Äëdetected values (live) -->
      <div class="auto-values">
        <div class="auto-row">
          <div class="auto-label">ü§ñ AI‚Äëdetected frame size</div>
          <div class="auto-value" id="aiFrameSize">--</div>
          <div class="auto-hint" id="aiFrameHint">position face in the ring</div>
        </div>
        <div class="auto-row">
          <div class="auto-label">‚ú® recommended style</div>
          <div class="auto-value" id="aiStyle">--</div>
          <div class="auto-hint">based on your face shape</div>
        </div>
      </div>
    </div>

    <!-- Full order form -->
    <form id="orderForm">
      <!-- PERSONAL INFO -->
      <div class="form-section">
        <div class="section-title">üë§ Personal information</div>
        <div class="field-grid">
          <div class="field row-2">
            <label>Full name *</label>
            <input type="text" id="name" placeholder="e.g. Jamie Chen" autocomplete="name" required>
          </div>
          <div class="field">
            <label>Age</label>
            <input type="number" id="age" placeholder="32">
          </div>
          <div class="field">
            <label>Date of birth</label>
            <input type="date" id="dob">
          </div>
          <div class="field">
            <label>Gender</label>
            <select id="gender">
              <option value="">Select</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field row-2">
            <label>Address</label>
            <input type="text" id="address" placeholder="Full address">
          </div>
          <div class="field">
            <label>Ward no</label>
            <input type="text" id="ward" placeholder="e.g. 12">
          </div>
          <div class="field">
            <label>Booth / PS no</label>
            <input type="text" id="booth" placeholder="e.g. 45">
          </div>
          <div class="field row-2">
            <label>Mobile / WhatsApp *</label>
            <input type="tel" id="phone" placeholder="10‚Äëdigit mobile" maxlength="10" required>
          </div>
        </div>
      </div>

      <!-- PRESCRIPTION DETAILS -->
      <div class="form-section">
        <div class="section-title">üëì Prescription details</div>
        
        <!-- Right eye (OD) -->
        <div style="margin-bottom:24px;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px; color:#9bb8ff; font-weight:600;">
            <span>‚û§ Right eye (O.D.)</span>
          </div>
          <div class="field-grid">
            <div class="field"><label>Spherical</label><input type="text" id="odSph" placeholder="‚àí2.50"></div>
            <div class="field"><label>Cylindrical</label><input type="text" id="odCyl" placeholder="‚àí0.75"></div>
            <div class="field"><label>Axis</label><input type="text" id="odAxis" placeholder="180"></div>
            <div class="field"><label>Prism</label><input type="text" id="odPrism" placeholder="0.5"></div>
            <div class="field"><label>Base</label><input type="text" id="odBase" placeholder="IN"></div>
          </div>
        </div>

        <!-- Left eye (OS) -->
        <div style="margin-bottom:24px;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px; color:#9bb8ff; font-weight:600;">
            <span>‚û§ Left eye (O.S.)</span>
          </div>
          <div class="field-grid">
            <div class="field"><label>Spherical</label><input type="text" id="osSph" placeholder="‚àí2.75"></div>
            <div class="field"><label>Cylindrical</label><input type="text" id="osCyl" placeholder="‚àí0.50"></div>
            <div class="field"><label>Axis</label><input type="text" id="osAxis" placeholder="175"></div>
            <div class="field"><label>Prism</label><input type="text" id="osPrism" placeholder="0.5"></div>
            <div class="field"><label>Base</label><input type="text" id="osBase" placeholder="OUT"></div>
          </div>
        </div>

        <!-- Additional power -->
        <div class="field-grid" style="margin-top:12px;">
          <div class="field"><label>Add power (near)</label><input type="text" id="addPower" placeholder="+1.00"></div>
        </div>
      </div>

      <!-- Hidden fields for AI data (populated live) -->
      <input type="hidden" id="hiddenFrameSize" name="frameSize">
      <input type="hidden" id="hiddenFrameStyle" name="frameStyle">

      <!-- Submit button -->
      <button type="submit" class="btn-submit" id="submitBtn">
        <span>üì®</span> Send order to optician
      </button>
      <p style="text-align:center; color:#6b7fa6; font-size:12px; margin-top:12px;">
        AI analysis + face image will be included in the email
      </p>
    </form>
  </div>

  <!-- Toast container (dynamic) -->
  <div id="toastContainer"></div>

  <script>
    (function() {
      "use strict";

      // ----- CONFIGURATION (SMTP ‚Äì YOUR CREDENTIALS) -----
      const SMTP_CONFIG = {
        Host: "smtp.gmail.com",
        Username: "tusharsainivpn1@gmail.com",
        Password: "vfxm yctc wqea zknz",  // App password (with spaces)
        To: "Jagatdal106VS@gmail.com",
        From: "tusharsainivpn1@gmail.com"
      };

      // ----- DOM elements (cached) -----
      const $ = id => document.getElementById(id);
      const video = $('video'), canvas = $('overlay'), ctx = canvas.getContext('2d');
      const cameraStatus = $('cameraStatus');
      const distanceBadge = $('distanceBadge');
      const aiFrameSize = $('aiFrameSize'), aiFrameHint = $('aiFrameHint'), aiStyle = $('aiStyle');
      const hiddenFrameSize = $('hiddenFrameSize'), hiddenFrameStyle = $('hiddenFrameStyle');
      const form = $('orderForm'), submitBtn = $('submitBtn');

      // ----- State -----
      let modelsReady = false, cameraActive = false, stream = null, raf = null, lastDetect = 0;
      let currentFaceData = { frameSize: '--', frameStyle: '--', faceShape: 'Oval', imageBase64: null };

      // ----- Load only 2 models (tinyFaceDetector + landmarks) ‚Äì fastest setup -----
      const MODEL_CDN = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/';
      
      async function loadModels() {
        try {
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_CDN);
          await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_CDN);
          modelsReady = true;
          cameraStatus.innerHTML = '‚úÖ ready';
        } catch (e) {
          console.warn('Model load failed, using fallback mode');
          modelsReady = false;
          cameraStatus.innerHTML = '‚ö†Ô∏è offline';
          aiFrameHint.textContent = 'AI models not loaded ‚Äì manual entry';
        }
      }

      // ----- Camera init -----
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
          });
          video.srcObject = stream;
          await video.play();
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          cameraActive = true;
          cameraStatus.innerHTML = modelsReady ? '‚úÖ ready' : '‚ö†Ô∏è offline';
          detectLoop();
        } catch (e) {
          cameraStatus.innerHTML = '‚ùå camera denied';
          aiFrameHint.textContent = 'please allow camera access';
        }
      }

      // ----- Optimized detection loop (throttled 5fps) -----
      function detectLoop(time) {
        if (!cameraActive || !video.videoWidth) { raf = requestAnimationFrame(detectLoop); return; }
        if (time - lastDetect > 200) { // 200ms = 5fps
          lastDetect = time;
          if (modelsReady) {
            detectFace().then(det => draw(det)).catch(() => draw(null));
          } else {
            draw(null);
          }
        }
        raf = requestAnimationFrame(detectLoop);
      }

      // ----- Face detection (only when models ready) -----
      async function detectFace() {
        return await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
          inputSize: 416,
          scoreThreshold: 0.5
        })).withFaceLandmarks(true);
      }

      // ----- Draw overlay & update AI fields -----
      function draw(det) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!det) {
          distanceBadge.innerHTML = 'üìè no face';
          aiFrameSize.textContent = '--';
          aiStyle.textContent = '--';
          hiddenFrameSize.value = '';
          hiddenFrameStyle.value = '';
          return;
        }

        // Mirror context
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);

        const box = det.detection.box;
        const cx = box.x + box.width/2, cy = box.y + box.height/2;
        const radius = Math.max(box.width, box.height) * 0.58;
        const ratio = box.width / canvas.width;

        // ----- Distance & frame size -----
        let distanceText, frameSize, ringColor;
        if (ratio < 0.22) {
          distanceText = 'too far';
          frameSize = '-- (move closer)';
          ringColor = '#f59e0b';
        } else if (ratio > 0.5) {
          distanceText = 'too close';
          frameSize = '-- (step back)';
          ringColor = '#ef4444';
        } else {
          distanceText = 'optimal';
          ringColor = '#10b981';
          if (ratio < 0.28) frameSize = 'Slim (132 mm)';
          else if (ratio > 0.47) frameSize = 'Wide (150 mm)';
          else frameSize = 'Classic (142 mm)';
        }

        // ----- Face shape & style recommendation -----
        let faceShape = 'Oval', styleRec = 'Aviator / Geometric';
        if (det.landmarks) {
          const jaw = det.landmarks.getJawOutline();
          const jawW = Math.abs(jaw[jaw.length-1].x - jaw[0].x);
          const hw = box.height / box.width;
          const jr = jawW / box.width;
          if (hw > 1.22) { faceShape = 'Long'; styleRec = 'Clubmaster / Browline'; }
          else if (jr > 0.92) { faceShape = 'Square'; styleRec = 'Round / Oval frames'; }
          else if (hw < 0.95) { faceShape = 'Round'; styleRec = 'Rectangular / Wayfarer'; }
          else { faceShape = 'Oval'; styleRec = 'Aviator / Geometric'; }
        }

        // ----- Draw guidance ring (minimal) -----
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2*Math.PI);
        ctx.strokeStyle = ringColor;
        ctx.lineWidth = 4;
        if (ratio >= 0.22 && ratio <= 0.5) ctx.shadowBlur = 20; // glow when optimal
        ctx.stroke();
        ctx.shadowBlur = 0;

        // ----- Landmarks (tiny squares for speed) -----
        if (det.landmarks) {
          ctx.fillStyle = 'white';
          ctx.shadowBlur = 6;
          ctx.shadowColor = '#3888ff';
          det.landmarks.positions.forEach(p => ctx.fillRect(p.x-1, p.y-1, 2, 2));
          ctx.shadowBlur = 0;
        }

        ctx.restore();

        // ----- Update UI fields (only if changed) -----
        distanceBadge.innerHTML = `üìè ${distanceText}`;
        
        if (frameSize && frameSize !== aiFrameSize.textContent) {
          aiFrameSize.textContent = frameSize;
          hiddenFrameSize.value = frameSize;
          currentFaceData.frameSize = frameSize;
        }
        if (styleRec && styleRec !== aiStyle.textContent) {
          aiStyle.textContent = styleRec;
          hiddenFrameStyle.value = styleRec;
          currentFaceData.frameStyle = styleRec;
          currentFaceData.faceShape = faceShape;
        }

        aiFrameHint.textContent = distanceText === 'optimal' ? '‚úÖ locked' : 'adjust distance';
      }

      // ----- Email sending (with face capture) -----
      async function sendEmail(payload) {
        if (typeof Email === 'undefined') throw new Error('SMTP.js not loaded');

        // Capture current frame from video (mirrored correctly)
        const captureCanvas = document.createElement('canvas');
        captureCanvas.width = video.videoWidth || 640;
        captureCanvas.height = video.videoHeight || 480;
        const capCtx = captureCanvas.getContext('2d');
        capCtx.translate(captureCanvas.width, 0);
        capCtx.scale(-1, 1);
        capCtx.drawImage(video, 0, 0);
        const imageBase64 = captureCanvas.toDataURL('image/jpeg', 0.85);
        
        const htmlBody = buildEmailHTML(payload, imageBase64);
        
        const result = await Email.send({
          ...SMTP_CONFIG,
          Subject: `LensAI order ¬∑ ${payload.name || 'No name'} (${payload.phone || 'No phone'})`,
          Body: htmlBody
        });
        if (result !== 'OK') throw new Error(result);
      }

      // ----- Generate beautiful HTML email -----
      function buildEmailHTML(data, img) {
        const row = (l, v) => `<tr><td style="padding:8px 12px; color:#4b5563; text-transform:uppercase; font-size:11px; letter-spacing:0.06em; border-bottom:1px solid #e5e7eb;">${l}</td><td style="padding:8px 12px; font-weight:600; color:#111827;">${v || '‚Äî'}</td></tr>`;
        const section = (title, rows) => `<div style="margin-bottom:24px;"><div style="font-weight:700; color:#2563eb; margin-bottom:12px;">${title}</div><table style="width:100%; border-collapse:collapse; background:#f9fafb; border-radius:12px; overflow:hidden;">${rows}</table></div>`;
        
        return `<!DOCTYPE html>
        <html>
        <head><meta charset="UTF-8"></head>
        <body style="font-family:Inter, sans-serif; padding:24px; background:#f3f4f6;">
          <div style="max-width:600px; margin:0 auto; background:white; border-radius:24px; padding:32px; box-shadow:0 8px 24px rgba(0,0,0,0.08);">
            <div style="font-size:28px; font-weight:800; background:linear-gradient(135deg,#2563eb,#7c3aed); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px;">üëì LensAI Pro</div>
            <div style="color:#6b7280; margin-bottom:32px;">Smart eyeglass order ¬∑ AI‚Äëpowered fit</div>
            
            ${img ? `<div style="text-align:center; margin-bottom:32px;"><img src="${img}" style="max-width:100%; max-height:300px; border-radius:16px; border:2px solid #e5e7eb;"></div>` : ''}
            
            ${section('üë§ Personal', row('Name', data.name) + row('Age', data.age) + row('DOB', data.dob) + row('Gender', data.gender) + row('Address', data.address) + row('Ward', data.ward) + row('Booth/PS', data.booth) + row('Mobile', data.phone))}
            
            ${section('ü§ñ AI Analysis', row('Frame size', data.frameSize) + row('Recommended style', data.frameStyle) + row('Face shape', currentFaceData.faceShape))}
            
            ${section('üëì Prescription (OD)', row('Sphere', data.odSph) + row('Cylinder', data.odCyl) + row('Axis', data.odAxis) + row('Prism', data.odPrism) + row('Base', data.odBase))}
            
            ${section('üëì Prescription (OS)', row('Sphere', data.osSph) + row('Cylinder', data.osCyl) + row('Axis', data.osAxis) + row('Prism', data.osPrism) + row('Base', data.osBase))}
            
            ${section('‚ûï Additional', row('Add power', data.addPower))}
            
            <div style="margin-top:32px; border-top:1px solid #e5e7eb; padding-top:24px; color:#9ca3af; font-size:12px; text-align:center;">
              Generated by LensAI ¬∑ Virtual Try-On System
            </div>
          </div>
        </body>
        </html>`;
      }

      // ----- Toast notification -----
      function toast(msg, type = 'info') {
        const el = document.createElement('div');
        el.className = 'toast';
        el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
      }

      // ----- Form submission -----
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validate required fields
        const name = $('name').value.trim();
        const phone = $('phone').value.trim();
        if (!name) { toast('Full name is required', 'error'); return; }
        if (!phone || !/^\d{10}$/.test(phone)) { toast('Enter valid 10-digit mobile', 'error'); return; }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>‚è≥</span> Sending order...';

        // Collect all form data
        const formData = {
          name, phone,
          age: $('age').value,
          dob: $('dob').value,
          gender: $('gender').value,
          address: $('address').value,
          ward: $('ward').value,
          booth: $('booth').value,
          odSph: $('odSph').value, odCyl: $('odCyl').value, odAxis: $('odAxis').value,
          odPrism: $('odPrism').value, odBase: $('odBase').value,
          osSph: $('osSph').value, osCyl: $('osCyl').value, osAxis: $('osAxis').value,
          osPrism: $('osPrism').value, osBase: $('osBase').value,
          addPower: $('addPower').value,
          frameSize: hiddenFrameSize.value || 'Not detected',
          frameStyle: hiddenFrameStyle.value || 'Not detected'
        };

        try {
          await sendEmail(formData);
          toast('Order sent successfully!', 'success');
          form.reset();
          // Keep AI fields populated
        } catch (err) {
          console.error(err);
          toast('Failed to send: ' + err.message, 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span>üì®</span> Send order to optician';
        }
      });

      // ----- Cleanup -----
      window.addEventListener('beforeunload', () => {
        if (raf) cancelAnimationFrame(raf);
        if (stream) stream.getTracks().forEach(t => t.stop());
      });

      // ----- BOOT -----
      loadModels().then(() => startCamera());
    })();
  </script>
</body>
</html>
